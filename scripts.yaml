install:
  (command): cd packages/sip && sip run install
  (description): Install `sip` globally
  (aliases):
    - i

compile-blob: sh packages/script_runner/scripts/compile_blob.sh {--platform} {--arch}

test:
  (command):
    - "{$test:sip}"
    - "{$test:script_runner}"
    - "{$test:console}"
  sip: cd packages/sip && sip run test --bail
  script_runner: cd packages/script_runner && sip run test --bail
  console: cd packages/console && sip run test --bail

prep:
  (command):
    - (+) {$prep:changelog}
    - (+) {$prep:license}
    - (+) {$prep:readme}
    - (+) {$prep:pubspecs}
  changelog: |
    echo "Copying CHANGELOG.md to all packages"
    for dir in $(ls -d packages/*); do
      cp CHANGELOG.md $dir/CHANGELOG.md
    done
  license: |
    echo "Copying LICENSE to all packages"
    for dir in $(ls -d packages/*); do
      cp LICENSE $dir/LICENSE
    done
  readme: |
    echo "Copying README.md to packages/sip & example"
    cp README.md packages/sip/README.md
    cp README.md packages/sip/example/README.md
  pubspecs: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

    echo "Updating pubspec.yaml version to $version"
    for dir in packages/*; do
      sed -i '' "s|^version: .*|version: $version|g" "$dir/pubspec.yaml"
    done

publish:
  (command):
    - "{$test}"
    - "{$prep}"
    - "{$publish:sip}"
    - "{$publish:script_runner}"
    - "{$publish:console}"
  sip: cd packages/sip; dart pub publish
  script_runner: cd packages/script_runner; dart pub publish
  console: cd packages/console; dart pub publish
