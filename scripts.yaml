install:
  (command): cd packages/sip && sip run install
  (description): Install `sip` globally
  (aliases):
    - i

compile-blob: sh packages/script_runner/scripts/compile_blob.sh {--platform} {--arch}

_packages:
  - cd packages/sip &&
  - cd packages/script_runner &&
  - cd packages/console &&

pana: "{$_packages} dart pub run pana"

format: "{$_packages} dart format ."
analyze: "{$_packages} dart analyze ."

prep:
  (command):
    - "{$install}"
    - (+) {$format} --set-exit-if-changed
    - (+) {$analyze} --fatal-infos --fatal-warnings
    - "{$prep:_build}"
    - (+) {$prep:changelog}
    - (+) {$prep:license}
    - (+) {$prep:readme}
    - (+) {$prep:pubspecs}
    - (+) {$prep:assets}
    - sip pub get -r
  _build:
    clean: sip run build_runner clean
    build: sip run build_runner build only
    (command):
      - echo "Running build_runner clean in all packages"
      - (+) {$_packages} {$prep:_build:clean}
      - echo "Running build_runner build in all packages"
      - (+) {$_packages} {$prep:_build:build}
      - echo "build_runner complete"
  changelog: |
    echo "Copying CHANGELOG.md to all packages"
    for dir in $(ls -d packages/*); do
      cp CHANGELOG.md $dir/CHANGELOG.md
    done
  license: |
    echo "Copying LICENSE to all packages"
    for dir in $(ls -d packages/*); do
      cp LICENSE $dir/LICENSE
    done
  readme: |
    echo "Copying README.md to packages/sip & example"
    cp README.md packages/sip/README.md
    cp README.md packages/sip/example/README.md
    # update asset paths to ../assets in example
    sed -i '' "s|assets/|../assets/|g" packages/sip/example/README.md
  pubspecs: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

    echo "Updating pubspec.yaml version to $version"
    for dir in packages/*; do
      sed -i '' "s|^version: .*|version: $version|g" "$dir/pubspec.yaml"
    done
  assets: |
    echo "Copying assets to packages/sip"
    rm -rf packages/sip/assets
    cp -r assets packages/sip

publish:
  (bail):
  (command):
    - sip test --bail --recursive --concurrent
    - "{$prep}"
    - "{$_packages} dart pub publish"
    - "{$publish:commit}"
    - "{$publish:tag}"
    - "{$publish:_push}"
  commit: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

    echo "Committing version $version"
    git add .
    git commit -m "v$version"
  tag: |
    # get version from changelog
    version=$(grep -m 1 "# " CHANGELOG.md | awk '{print $2}')

    echo "Tagging version $version"
    git tag -a "v$version" -m "v$version"
  _push: |
    echo "Pushing to origin"
    git push
    git push --tags
